#!/bin/env bash

# Update bootc containers
# SPDX-License-Identifier: MIT
set -eu

# Which PROJECTS should be built?
PROJECTS=()

# Branch to use for automatic update build
BRANCH="master"
AUTOUPDATE_DIR="${HOME}/auto-updates"
REPODIR="${HOME}/repos/"

if [[ ! -d ~/auto-updates/ ]]; then
	mkdir -p "${AUTOUPDATE_DIR}"
fi

for project in "${PROJECTS[@]}"; do
	git clone --branch "${BRANCH}" "${REPODIR}/${project}.git" "${AUTOUPDATE_DIR}/${project}"

	if [[ -f ${AUTOUPDATE_DIR}/${project}/.simple-ci/master.conf ]]; then
		buildid=$(date -u +%Y%m%d.%H%M)

		# shellcheck source=/dev/null
		source "${AUTOUPDATE_DIR}/${project}/.simple-ci/master.conf"

		if [[ ${PIPELINE} == "podman" ]]; then
			"${HOME}"/.ci/scripts/build-podman -p "${project}" \
				-w "${AUTOUPDATE_DIR}/${project}" \
				-b "${buildid}" \
				-c "${AUTOUPDATE_DIR}/${project}/.simple-ci/master.conf"
		elif [[ ${PIPELINE} == "generic" ]]; then
			"${HOME}"/.ci/scripts/build-generic -p "${project}" \
				-w "${AUTOUPDATE_DIR}/${project}" \
				-b "${buildid}" \
				-c "${AUTOUPDATE_DIR}/${project}/.simple-ci/master.conf"
		fi
	else
		echo "WARNING: No ${BRANCH}.conf found in project ${project}."
	fi
	rm -rf "${AUTOUPDATE_DIR:?}/${project}"
done
